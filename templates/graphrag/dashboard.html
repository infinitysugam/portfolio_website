{% extends 'graphrag/base.html' %}

{% block title %}Dashboard - Supply Chain Forecasting{% endblock %}

{% block content %}
<div class="w-full px-6">
    <div class="mb-6">
        <h1 class="text-4xl font-bold text-gray-900 mb-2">
            <i class="fas fa-dashboard text-purple-600"></i>
            Forecasting Dashboard
        </h1>
        <p class="text-gray-600">SKU123 - North Region</p>
    </div>

    <!-- Run Forecast Button -->
    <div class="bg-white rounded-lg shadow-lg p-6 mb-6">
        <div class="flex items-center justify-between">
            <div>
                <h2 class="text-2xl font-bold text-gray-900 mb-2">
                    <i class="fas fa-play-circle text-purple-600 mr-2"></i>
                    Forecast Control
                </h2>
                <p class="text-gray-600">Click the button to run the forecast analysis</p>
            </div>
            <button id="runForecastBtn" class="bg-purple-600 hover:bg-purple-700 text-white font-bold py-3 px-6 rounded-lg shadow-lg transition duration-200 flex items-center">
                <i class="fas fa-play mr-2"></i>
                Run Forecast
            </button>
        </div>
        <div id="loadingIndicator" class="hidden mt-4">
            <div class="flex items-center justify-center">
                <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-purple-600 mr-3"></div>
                <span class="text-gray-700">Running forecast analysis...</span>
            </div>
        </div>
    </div>

    <!-- Results Container -->
    <div id="resultsContainer" class="hidden">
    <!-- Recent Data Section -->
    <div class="bg-white rounded-lg shadow-lg p-6 mb-6">
        <h2 class="text-2xl font-bold text-gray-900 mb-4">
            <i class="fas fa-database text-purple-600 mr-2"></i>
            Recent Historical Data (Last 14 Days)
        </h2>
        <div class="overflow-x-auto">
            <table class="min-w-full divide-y divide-gray-200">
                <thead class="bg-gray-50">
                    <tr>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Date</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Demand</th>
                    </tr>
                </thead>
                <tbody class="bg-white divide-y divide-gray-200">
                    {% for date, demand in recent_data.items %}
                    <tr class="hover:bg-gray-50">
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">{{ date }}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{{ demand }} units</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

    <!-- ML Forecast & LLM Explanations Side-by-Side -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
        <!-- ML Forecast Section -->
        <div class="bg-white rounded-lg shadow-lg p-6">
            <h2 class="text-2xl font-bold text-gray-900 mb-4">
                <i class="fas fa-brain text-purple-600 mr-2"></i>
                ML Model Forecast (ARIMA)
            </h2>
            <div id="mlForecastContainer" class="space-y-3 mb-6">
                <!-- ML forecast will be populated here -->
            </div>
            <details class="mt-4">
                <summary class="cursor-pointer text-purple-600 font-semibold hover:text-purple-700">
                    <i class="fas fa-chart-line mr-1"></i>
                    View Model Summary
                </summary>
                <pre id="mlSummary" class="mt-4 bg-gray-50 p-4 rounded-lg text-xs overflow-x-auto"><!-- ML summary will be populated here --></pre>
            </details>
        </div>

        <!-- LLM Explanations Section -->
        <div class="bg-white rounded-lg shadow-lg p-6">
            <h2 class="text-2xl font-bold text-gray-900 mb-4">
                <i class="fas fa-lightbulb text-purple-600 mr-2"></i>
                AI-Generated Forecast Explanations
            </h2>
            <div id="explanationsContainer" class="space-y-3">
                <!-- Explanations will be populated here -->
            </div>
        </div>
    </div>

    <!-- LLM Forecast Section -->
    <div class="bg-white rounded-lg shadow-lg p-6 mb-6">
        <h2 class="text-2xl font-bold text-gray-900 mb-4">
            <i class="fas fa-robot text-purple-600 mr-2"></i>
            LLM Forecast (GPT-3.5)
        </h2>
        <div id="llmForecastContainer" class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-7 gap-3">
            <!-- LLM forecast will be populated here -->
        </div>
    </div>

    <!-- Visualizations Side-by-Side -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
        <!-- Forecast Visualization -->
        <div class="bg-white rounded-lg shadow-lg p-6">
            <h2 class="text-2xl font-bold text-gray-900 mb-4">
                <i class="fas fa-chart-bar text-purple-600 mr-2"></i>
                Forecast Visualization
            </h2>
            <div class="bg-gray-50 rounded-lg p-4">
                <img id="forecastViz" src="" alt="Forecast Visualization" class="w-full h-auto rounded-lg shadow-md">
            </div>
            <div class="mt-4 grid grid-cols-3 gap-3">
                <div class="bg-blue-50 rounded-lg p-3 text-center">
                    <div class="text-blue-600 font-semibold text-sm mb-1">Historical</div>
                    <div class="text-xs text-gray-600">Past demand</div>
                </div>
                <div class="bg-red-50 rounded-lg p-3 text-center">
                    <div class="text-red-600 font-semibold text-sm mb-1">ML Forecast</div>
                    <div class="text-xs text-gray-600">ARIMA</div>
                </div>
                <div class="bg-green-50 rounded-lg p-3 text-center">
                    <div class="text-green-600 font-semibold text-sm mb-1">LLM Forecast</div>
                    <div class="text-xs text-gray-600">GPT</div>
                </div>
            </div>
        </div>

        <!-- Graph RAG Section -->
        <div class="bg-white rounded-lg shadow-lg p-6">
            <h2 class="text-2xl font-bold text-gray-900 mb-4">
                <i class="fas fa-project-diagram text-purple-600 mr-2"></i>
                Supply Chain Knowledge Graph
            </h2>
            <div class="bg-gray-50 rounded-lg p-4 mb-4">
                <img id="graphViz" src="" alt="Knowledge Graph" class="w-full h-auto rounded-lg shadow-md">
            </div>
            <div class="bg-gradient-to-r from-blue-50 to-cyan-50 rounded-lg p-4 border border-blue-200">
                <h3 class="font-bold text-gray-900 mb-2 text-sm">
                    <i class="fas fa-comment-dots text-blue-600 mr-2"></i>
                    Graph RAG Explanation
                </h3>
                <p id="graphExplanation" class="text-gray-700 text-sm"><!-- Graph explanation will be populated here --></p>
            </div>
        </div>
    </div>

    <!-- Graph Legend -->
    <div class="bg-white rounded-lg shadow-lg p-6 mb-6">
        <h3 class="text-lg font-bold text-gray-900 mb-3">Graph Legend</h3>
        <div class="grid grid-cols-3 md:grid-cols-6 gap-3">
            <div class="bg-red-50 rounded-lg p-2 text-center">
                <div class="w-3 h-3 bg-red-500 rounded-full mx-auto mb-1"></div>
                <div class="text-xs font-semibold">Supplier</div>
            </div>
            <div class="bg-orange-50 rounded-lg p-2 text-center">
                <div class="w-3 h-3 bg-orange-500 rounded-full mx-auto mb-1"></div>
                <div class="text-xs font-semibold">Plant</div>
            </div>
            <div class="bg-green-50 rounded-lg p-2 text-center">
                <div class="w-3 h-3 bg-green-500 rounded-full mx-auto mb-1"></div>
                <div class="text-xs font-semibold">SKU</div>
            </div>
            <div class="bg-blue-50 rounded-lg p-2 text-center">
                <div class="w-3 h-3 bg-blue-500 rounded-full mx-auto mb-1"></div>
                <div class="text-xs font-semibold">Warehouse</div>
            </div>
            <div class="bg-purple-50 rounded-lg p-2 text-center">
                <div class="w-3 h-3 bg-purple-500 rounded-full mx-auto mb-1"></div>
                <div class="text-xs font-semibold">Customer</div>
            </div>
            <div class="bg-pink-50 rounded-lg p-2 text-center">
                <div class="w-3 h-3 bg-pink-500 rounded-full mx-auto mb-1"></div>
                <div class="text-xs font-semibold">Event</div>
            </div>
        </div>
    </div>

    <!-- Summary Section -->
    <div class="bg-gradient-to-r from-purple-600 to-indigo-600 rounded-lg shadow-lg p-6 text-white">
        <h2 class="text-2xl font-bold mb-4">
            <i class="fas fa-check-circle mr-2"></i>
            Summary
        </h2>
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
            <div class="bg-white bg-opacity-20 rounded-lg p-4">
                <div class="text-sm opacity-90 mb-1">ML Forecast Range</div>
                <div id="mlRange" class="text-xl font-bold">--</div>
            </div>
            <div class="bg-white bg-opacity-20 rounded-lg p-4">
                <div class="text-sm opacity-90 mb-1">LLM Forecast Range</div>
                <div id="llmRange" class="text-xl font-bold">--</div>
            </div>
            <div class="bg-white bg-opacity-20 rounded-lg p-4">
                <div class="text-sm opacity-90 mb-1">Forecast Period</div>
                <div class="text-xl font-bold">7 Days</div>
            </div>
        </div>
    </div>
    </div> <!-- End Results Container -->
</div>

<script>
document.getElementById('runForecastBtn').addEventListener('click', function() {
    const btn = this;
    const loadingIndicator = document.getElementById('loadingIndicator');
    const resultsContainer = document.getElementById('resultsContainer');
    
    // Disable button and show loading
    btn.disabled = true;
    btn.classList.add('opacity-50', 'cursor-not-allowed');
    loadingIndicator.classList.remove('hidden');
    
    // Make AJAX request to run forecast
    fetch('{% url "graphrag:run_forecast" %}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': '{{ csrf_token }}'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Populate results
            populateResults(data);
            resultsContainer.classList.remove('hidden');
            loadingIndicator.classList.add('hidden');
            btn.innerHTML = '<i class="fas fa-check mr-2"></i>Forecast Complete';
            btn.classList.remove('bg-purple-600', 'hover:bg-purple-700');
            btn.classList.add('bg-green-600');
        } else {
            alert('Error running forecast: ' + data.error);
            loadingIndicator.classList.add('hidden');
            btn.disabled = false;
            btn.classList.remove('opacity-50', 'cursor-not-allowed');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Error running forecast. Check console for details.');
        loadingIndicator.classList.add('hidden');
        btn.disabled = false;
        btn.classList.remove('opacity-50', 'cursor-not-allowed');
    });
});

function populateResults(data) {
    // Populate Recent Data
    const recentDataBody = document.querySelector('#resultsContainer tbody');
    recentDataBody.innerHTML = '';
    for (const [date, demand] of Object.entries(data.recent_data)) {
        const row = `<tr class="hover:bg-gray-50">
            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${date}</td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${demand} units</td>
        </tr>`;
        recentDataBody.innerHTML += row;
    }
    
    // Populate ML Forecast (vertical layout for side-by-side comparison)
    const mlForecastContainer = document.querySelector('#mlForecastContainer');
    mlForecastContainer.innerHTML = '';
    for (const [date, value] of Object.entries(data.ml_forecast)) {
        const card = `<div class="bg-gradient-to-r from-purple-50 to-indigo-50 rounded-lg p-3 border border-purple-200">
            <div class="flex justify-between items-center">
                <div class="text-sm text-gray-600">${date}</div>
                <div class="text-lg font-bold text-purple-600">${parseFloat(value).toFixed(2)}</div>
            </div>
        </div>`;
        mlForecastContainer.innerHTML += card;
    }
    
    // Populate ML Summary
    document.getElementById('mlSummary').textContent = data.ml_summary;
    
    // Populate LLM Forecast (compact grid layout)
    const llmForecastContainer = document.querySelector('#llmForecastContainer');
    llmForecastContainer.innerHTML = '';
    for (const [date, value] of Object.entries(data.llm_forecast)) {
        const card = `<div class="bg-gradient-to-r from-green-50 to-emerald-50 rounded-lg p-3 border border-green-200">
            <div class="text-xs text-gray-600 mb-1">${date.split('-').slice(1).join('/')}</div>
            <div class="text-lg font-bold text-green-600">${value}</div>
        </div>`;
        llmForecastContainer.innerHTML += card;
    }
    
    // Populate Explanations (vertical layout for side-by-side comparison)
    const explanationsContainer = document.querySelector('#explanationsContainer');
    explanationsContainer.innerHTML = '';
    for (const [date, explanation] of Object.entries(data.explanations)) {
        const card = `<div class="bg-gradient-to-r from-yellow-50 to-amber-50 rounded-lg p-3 border border-yellow-200">
            <div class="font-bold text-gray-900 mb-1 text-sm">${date}</div>
            <p class="text-gray-700 text-xs leading-relaxed">${explanation}</p>
        </div>`;
        explanationsContainer.innerHTML += card;
    }
    
    // Populate Visualizations
    document.getElementById('forecastViz').src = 'data:image/png;base64,' + data.visualization;
    document.getElementById('graphViz').src = 'data:image/png;base64,' + data.graph_visualization;
    document.getElementById('graphExplanation').textContent = data.graph_explanation;
    
    // Populate Summary
    const mlValues = Object.values(data.ml_forecast);
    const llmValues = Object.values(data.llm_forecast);
    document.getElementById('mlRange').textContent = `${Math.round(mlValues[0])} - ${Math.round(mlValues[mlValues.length - 1])}`;
    document.getElementById('llmRange').textContent = `${llmValues[0]} - ${llmValues[llmValues.length - 1]}`;
}
</script>
{% endblock %}
